# Cleanup Pending Records Script - å®ç°æ€»ç»“

## ä»»åŠ¡éœ€æ±‚

åˆ›å»ºä¸€ä¸ªè„šæœ¬æ¸…é™¤ `news_results` è¡¨ä¸­ `status` çŠ¶æ€ä¸º `pending` çš„æ•°æ®ã€‚

## å®ç°æ–¹æ¡ˆ

### 1. è„šæœ¬æ–‡ä»¶

**ä½ç½®**: `scripts/cleanup_pending_news_results.py`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… æŸ¥è¯¢å¹¶ç»Ÿè®¡ `status="pending"` çš„è®°å½•
- âœ… æä¾›å®‰å…¨çš„ dry-run é¢„è§ˆæ¨¡å¼
- âœ… æ”¯æŒæŒ‰æ—¶é—´èŒƒå›´è¿‡æ»¤ï¼ˆ--days å‚æ•°ï¼‰
- âœ… è¯¦ç»†çš„ç»Ÿè®¡æŠ¥å‘Šå’Œæ ·æœ¬å±•ç¤º
- âœ… åˆ é™¤å‰ç¡®è®¤æœºåˆ¶
- âœ… åˆ é™¤åç»“æœéªŒè¯

### 2. æŠ€æœ¯å®ç°

#### æ•°æ®åº“è¿æ¥
```python
from src.infrastructure.database.connection import get_mongodb_database

db = await get_mongodb_database()
collection = db.news_results
```

#### æŸ¥è¯¢é€»è¾‘
```python
# åŸºç¡€æŸ¥è¯¢
query = {"status": "pending"}

# å¯é€‰æ—¶é—´è¿‡æ»¤
if days is not None:
    cutoff_date = datetime.now(timezone.utc) - timedelta(days=days)
    query["created_at"] = {"$lt": cutoff_date}
```

#### ç»Ÿè®¡åˆ†æ
- æ€»è®°å½•æ•°ç»Ÿè®¡
- æŒ‰ä»»åŠ¡åˆ†ç»„ç»Ÿè®¡ï¼ˆTop 10ï¼‰
- æ ·æœ¬æ•°æ®å±•ç¤ºï¼ˆå‰ 5 æ¡ï¼‰

#### å®‰å…¨åˆ é™¤
```python
# Dry-run æ¨¡å¼
if dry_run:
    count = await collection.count_documents(query)
    return {"dry_run": True, "matched_count": count}

# å®é™…åˆ é™¤
result = await collection.delete_many(query)
return {"deleted_count": result.deleted_count}
```

### 3. ä½¿ç”¨æ–¹å¼

#### é¢„è§ˆæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
```bash
# æŸ¥çœ‹æ‰€æœ‰ pending è®°å½•
python3 scripts/cleanup_pending_news_results.py

# æŸ¥çœ‹ 7 å¤©å‰çš„ pending è®°å½•
python3 scripts/cleanup_pending_news_results.py --days 7
```

#### æ‰§è¡Œåˆ é™¤
```bash
# åˆ é™¤æ‰€æœ‰ pending è®°å½•
python3 scripts/cleanup_pending_news_results.py --execute

# åªåˆ é™¤ 7 å¤©å‰çš„è®°å½•
python3 scripts/cleanup_pending_news_results.py --execute --days 7
```

### 4. å®æµ‹ç»“æœ

#### æµ‹è¯•ç¯å¢ƒç»Ÿè®¡

**å½“å‰æ•°æ®åº“çŠ¶æ€**:
```
ğŸ“ˆ æ€»è®¡: 4838 æ¡ pending è®°å½•

ğŸ“‹ æŒ‰ä»»åŠ¡åˆ†ç»„ç»Ÿè®¡ (Top 10):
  1. Task ID: 245059966926098432
     æ•°é‡: 3816 æ¡
  2. Task ID: 244895743529586688
     æ•°é‡: 350 æ¡
  3. Task ID: 245059137561202688
     æ•°é‡: 206 æ¡
  ...
```

**æ ·æœ¬æ•°æ®**:
```
ğŸ” æ ·æœ¬æ•°æ® (å‰5æ¡):
  [1] ID: 244879702695698432
      Task: 244879584026255360
      Title: Editor in-Chief - Tibet Post International
      URL: https://www.thetibetpost.com/editor-in-chief
      Created: 2025-11-06 17:44:30
  ...
```

### 5. å®‰å…¨æœºåˆ¶

1. **é»˜è®¤é¢„è§ˆæ¨¡å¼** - ä¸åŠ  `--execute` ä¸ä¼šåˆ é™¤æ•°æ®
2. **æ˜ç¡®ç¡®è®¤** - æ‰§è¡Œåˆ é™¤å‰éœ€è¦è¾“å…¥ `yes` ç¡®è®¤
3. **æ—¶é—´è¿‡æ»¤** - æ”¯æŒ `--days` å‚æ•°é¿å…è¯¯åˆ æ–°æ•°æ®
4. **è¯¦ç»†ç»Ÿè®¡** - åˆ é™¤å‰æ˜¾ç¤ºå®Œæ•´çš„ç›®æ ‡è®°å½•ç»Ÿè®¡
5. **ç»“æœéªŒè¯** - åˆ é™¤åè‡ªåŠ¨éªŒè¯å¹¶æ˜¾ç¤ºå‰©ä½™è®°å½•æ•°
6. **é”™è¯¯å¤„ç†** - å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé”™è¯¯æç¤º

### 6. é¡¹ç›®é›†æˆ

#### ä¾èµ–é¡¹
- `motor` - MongoDB async driverï¼ˆå·²å­˜åœ¨ï¼‰
- `src.infrastructure.database.connection` - æ•°æ®åº“è¿æ¥å·¥å…·ï¼ˆå·²å­˜åœ¨ï¼‰
- `src.utils.logger` - æ—¥å¿—å·¥å…·ï¼ˆå·²å­˜åœ¨ï¼‰

#### æ–‡ä»¶ç»“æ„
```
scripts/
â”œâ”€â”€ cleanup_pending_news_results.py   # ä¸»è„šæœ¬
â”œâ”€â”€ fix_news_results_status.py        # ä¿®å¤çŠ¶æ€è„šæœ¬ï¼ˆå·²å­˜åœ¨ï¼‰
â””â”€â”€ cleanup_old_processed_results.py  # æ¸…ç†æ—§è¡¨è„šæœ¬ï¼ˆå·²å­˜åœ¨ï¼‰

claudedocs/
â””â”€â”€ CLEANUP_PENDING_RECORDS_GUIDE.md  # ä½¿ç”¨æŒ‡å—
```

### 7. ä»£ç è´¨é‡

#### è®¾è®¡æ¨¡å¼
- âœ… **å…³æ³¨ç‚¹åˆ†ç¦»** - ç»Ÿè®¡ã€åˆ é™¤ã€æ‰“å°åŠŸèƒ½ç‹¬ç«‹
- âœ… **å•ä¸€èŒè´£** - æ¯ä¸ªå‡½æ•°åªè´Ÿè´£ä¸€ä¸ªä»»åŠ¡
- âœ… **å¼‚æ­¥è®¾è®¡** - ä½¿ç”¨ async/await æ¨¡å¼
- âœ… **å¯é…ç½®æ€§** - å‘½ä»¤è¡Œå‚æ•°çµæ´»é…ç½®

#### ä»£ç è§„èŒƒ
- âœ… **ç±»å‹æç¤º** - å®Œæ•´çš„ç±»å‹æ³¨è§£
- âœ… **æ–‡æ¡£å­—ç¬¦ä¸²** - è¯¦ç»†çš„å‡½æ•°è¯´æ˜
- âœ… **é”™è¯¯å¤„ç†** - å®Œå–„çš„å¼‚å¸¸æ•è·
- âœ… **æ—¥å¿—è®°å½•** - ä½¿ç”¨é¡¹ç›®ç»Ÿä¸€çš„æ—¥å¿—å·¥å…·

#### Python æœ€ä½³å®è·µ
- âœ… **Shebang** - `#!/usr/bin/env python3`
- âœ… **å¯æ‰§è¡Œæƒé™** - `chmod +x`
- âœ… **æ—¶åŒºæ„ŸçŸ¥** - ä½¿ç”¨ `timezone.utc` é¿å…è­¦å‘Š
- âœ… **è·¯å¾„å¤„ç†** - ä½¿ç”¨ `pathlib.Path`
- âœ… **å‚æ•°è§£æ** - ä½¿ç”¨ `argparse` æ ‡å‡†åº“

### 8. è¾“å‡ºç¤ºä¾‹

#### Dry-run æ¨¡å¼è¾“å‡º
```
======================================================================
ğŸ—‘ï¸  æ¸…ç† news_results Pending è®°å½•
======================================================================
æ‰§è¡Œæ—¶é—´: 2025-11-18 13:41:33
æ¨¡å¼: ğŸ” DRY-RUNï¼ˆé¢„è§ˆæ¨¡å¼ï¼Œä¸ä¼šåˆ é™¤æ•°æ®ï¼‰
æç¤º: ä½¿ç”¨ --execute å‚æ•°æ‰§è¡Œå®é™…åˆ é™¤

ğŸ“ è¿æ¥æ•°æ®åº“...
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ

ğŸ“Š åˆ†æ pending è®°å½•...
ğŸ“ˆ æ€»è®¡: 4838 æ¡ pending è®°å½•

ğŸ’¡ é¢„è§ˆæ¨¡å¼å®Œæˆ
   å°†åˆ é™¤ 4838 æ¡è®°å½•
   ä½¿ç”¨ --execute å‚æ•°æ‰§è¡Œå®é™…åˆ é™¤
```

#### Execute æ¨¡å¼è¾“å‡º
```
æ¨¡å¼: âš¡ EXECUTEï¼ˆå°†æ‰§è¡Œåˆ é™¤æ“ä½œï¼‰

âš ï¸  å‡†å¤‡åˆ é™¤ pending è®°å½•
   æ•°é‡: 4838 æ¡
   èŒƒå›´: æ‰€æœ‰ pending è®°å½•

âš ï¸  æ­¤æ“ä½œä¸å¯é€†ï¼

ç¡®è®¤åˆ é™¤? (yes/no): yes

ğŸ—‘ï¸  æ­£åœ¨åˆ é™¤è®°å½•...
âœ… åˆ é™¤å®Œæˆ!
   åˆ é™¤è®°å½•æ•°: 4838

ğŸ“ éªŒè¯åˆ é™¤ç»“æœ...
âœ… æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„ pending è®°å½•å·²åˆ é™¤

ğŸ‰ æ¸…ç†å®Œæˆ!
âœ… å·²åˆ é™¤: 4838 æ¡ pending è®°å½•
âœ… å½“å‰ pending è®°å½•æ•°: 0
```

### 9. ç›¸å…³å‚è€ƒ

#### æ•°æ®æ¨¡å‹
**æ–‡ä»¶**: `src/core/domain/entities/processed_result.py`

**çŠ¶æ€æšä¸¾**:
```python
class ProcessedStatus(Enum):
    PENDING = "pending"         # å¾…AIå¤„ç†
    PROCESSING = "processing"   # AIå¤„ç†ä¸­
    COMPLETED = "completed"     # AIå¤„ç†å®Œæˆ
    FAILED = "failed"           # AIå¤„ç†å¤±è´¥
    ARCHIVED = "archived"       # ç”¨æˆ·ç•™å­˜
    DELETED = "deleted"         # ç”¨æˆ·åˆ é™¤
```

#### ç±»ä¼¼è„šæœ¬
- `scripts/fix_news_results_status.py` - ä¿®å¤é”™è¯¯çš„ status å€¼
- `scripts/cleanup_old_processed_results.py` - æ¸…ç†æ—§è¡¨

### 10. æ–‡æ¡£äº¤ä»˜

1. **è„šæœ¬æ–‡ä»¶**: `scripts/cleanup_pending_news_results.py` (258 è¡Œ)
2. **ä½¿ç”¨æŒ‡å—**: `claudedocs/CLEANUP_PENDING_RECORDS_GUIDE.md` (å®Œæ•´æ–‡æ¡£)
3. **å®ç°æ€»ç»“**: `claudedocs/CLEANUP_SCRIPT_SUMMARY_2025-11-18.md` (æœ¬æ–‡ä»¶)

### 11. åç»­å»ºè®®

#### åŠŸèƒ½æ‰©å±•
- æ”¯æŒæŒ‰ `task_id` è¿‡æ»¤åˆ é™¤ç‰¹å®šä»»åŠ¡çš„è®°å½•
- æ·»åŠ å¯¼å‡ºåŠŸèƒ½ï¼ˆåˆ é™¤å‰å¯¼å‡ºåˆ° JSON/CSVï¼‰
- æ”¯æŒæ‰¹é‡åˆ é™¤å…¶ä»–çŠ¶æ€ï¼ˆfailed, processing ç­‰ï¼‰
- æ·»åŠ å®šæ—¶æ¸…ç†åŠŸèƒ½ï¼ˆcron jobï¼‰

#### æ€§èƒ½ä¼˜åŒ–
- å¤§æ‰¹é‡åˆ é™¤æ—¶ä½¿ç”¨æ‰¹å¤„ç†ï¼ˆbatch deleteï¼‰
- æ·»åŠ è¿›åº¦æ¡æ˜¾ç¤ºï¼ˆtqdmï¼‰
- æ”¯æŒå¹¶å‘åˆ é™¤å¤šä¸ªä»»åŠ¡

#### ç›‘æ§å‘Šè­¦
- é›†æˆåˆ°ç³»ç»Ÿç›‘æ§ï¼ˆè®°å½•åˆ é™¤æ“ä½œæ—¥å¿—ï¼‰
- æ·»åŠ  Slack/Email é€šçŸ¥
- ç”Ÿæˆæ¸…ç†æŠ¥å‘Š

---

## æ€»ç»“

âœ… **ä»»åŠ¡å®Œæˆ** - æˆåŠŸåˆ›å»ºäº†å®‰å…¨å¯é çš„ pending è®°å½•æ¸…ç†è„šæœ¬
âœ… **åŠŸèƒ½å®Œæ•´** - åŒ…å«é¢„è§ˆã€è¿‡æ»¤ã€ç»Ÿè®¡ã€åˆ é™¤ã€éªŒè¯ç­‰å®Œæ•´åŠŸèƒ½
âœ… **å®‰å…¨æ€§é«˜** - å¤šé‡å®‰å…¨æœºåˆ¶é˜²æ­¢è¯¯åˆ æ•°æ®
âœ… **æ˜“äºä½¿ç”¨** - æ¸…æ™°çš„å‘½ä»¤è¡Œæ¥å£å’Œè¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£
âœ… **ä»£ç è´¨é‡** - éµå¾ªé¡¹ç›®è§„èŒƒå’Œ Python æœ€ä½³å®è·µ

**è„šæœ¬å·²å°±ç»ªï¼Œå¯ä»¥å®‰å…¨ä½¿ç”¨ï¼**

---

**ä½œè€…**: Claude Code
**åˆ›å»ºæ—¥æœŸ**: 2025-11-18
**å®æµ‹çŠ¶æ€**: âœ… é€šè¿‡ï¼ˆDry-run æ¨¡å¼éªŒè¯æˆåŠŸï¼‰
