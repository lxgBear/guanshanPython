# v2.1.1 å®Œæ•´ä¿®å¤æ€»ç»“

**ç‰ˆæœ¬**: v2.1.1 Hotfix
**ä¿®å¤æ—¥æœŸ**: 2025-11-07
**çŠ¶æ€**: âœ… ä»£ç ä¿®å¤å®Œæˆï¼Œç­‰å¾…éªŒè¯

---

## ä¿®å¤æ¸…å•

### âœ… ä¿®å¤ 1: API Validation Bug (å·²å®Œæˆ)

**é—®é¢˜**: Pydantic éªŒè¯è§„åˆ™ç¼ºå°‘ `map_scrape_website` ä»»åŠ¡ç±»å‹

**ä¿®å¤ä½ç½®**: `/Users/lanxionggao/Documents/guanshanPython/src/api/v1/endpoints/search_tasks_frontend.py`

**ä¿®å¤å†…å®¹**:
1. Line 57-62: `SearchTaskCreate.task_type` - æ·»åŠ  `map_scrape_website` åˆ° pattern
2. Line 149-154: `SearchTaskUpdate.task_type` - æ·»åŠ  `map_scrape_website` åˆ° pattern
3. Line 176-178: `SearchTaskResponse.task_type` - æ›´æ–° description
4. Line 227-233: `task_to_response()` - æ·»åŠ  `map_scrape_website` åˆ° task_mode_map

**éªŒè¯çŠ¶æ€**: âœ… æœåŠ¡å·²é‡è½½ (02:14:00)ï¼ŒAPI ç°åœ¨æ¥å— `map_scrape_website` ç±»å‹

**æ–‡æ¡£**: `claudedocs/V2.1.1_API_VALIDATION_BUG_FIX.md`

---

### âœ… ä¿®å¤ 2: Firecrawl wait_for/timeout å‚æ•°å†²çª (å·²å®Œæˆ)

**é—®é¢˜**: æ‰€æœ‰ Scrape API è°ƒç”¨å¤±è´¥ï¼Œé”™è¯¯: "waitFor must not exceed half of timeout"

**æ ¹æœ¬åŸå› **:
- æ—§é…ç½®: `waitFor=1000ms`ï¼Œæœªæ˜¾å¼ä¼ é€’ `timeout` å‚æ•°
- Firecrawl é»˜è®¤ timeout: ~2000ms
- è¦æ±‚: `waitFor < (timeout / 2)`
- ç»“æœ: `1000ms â‰® 1000ms` - ä¸¥æ ¼å°äºæ£€æŸ¥å¤±è´¥

**ä¿®å¤ä½ç½®**: `/Users/lanxionggao/Documents/guanshanPython/src/infrastructure/crawlers/firecrawl_adapter.py`

**ä¿®å¤å†…å®¹**:

#### 1. FirecrawlAdapter.scrape() æ–¹æ³• (Line 77-85)
```python
# ä¿®å¤å‰
wait_for = options.get('wait_for', 1000)
timeout = options.get('timeout', self.timeout)
logger.info(f"çˆ¬å–å‚æ•°: formats={formats}, onlyMainContent={only_main_content}, waitFor={wait_for}ms")

# ä¿®å¤å (v2.1.1)
wait_for = options.get('wait_for', 500)  # v2.1.1: æ”¹ä¸º 500ms é¿å… timeout å†²çª
timeout = options.get('timeout', 30)  # v2.1.1: å•ä¸ª Scrape è¯·æ±‚ 30ç§’è¶…æ—¶
logger.info(f"çˆ¬å–å‚æ•°: formats={formats}, onlyMainContent={only_main_content}, waitFor={wait_for}ms, timeout={timeout}s")
```

#### 2. FirecrawlAdapter.crawl() æ–¹æ³• (Line 147-153)
```python
# ä¿®å¤å‰
wait_for=options.get('wait_for', 1000)

# ä¿®å¤å (v2.1.1)
wait_for=options.get('wait_for', 500)  # v2.1.1: æ”¹ä¸º 500ms é¿å… timeout å†²çª
```

#### 3. FirecrawlAdapter._build_scrape_options() æ–¹æ³• (Line 374-377)
```python
# ä¿®å¤å‰
'waitFor': options.get('wait_for', 1000)

# ä¿®å¤å (v2.1.1)
'waitFor': options.get('wait_for', 500)  # v2.1.1: æ”¹ä¸º 500ms é¿å… timeout å†²çª
```

**éªŒè¯çŠ¶æ€**: âœ… ä»£ç ä¿®å¤å®Œæˆï¼ŒæœåŠ¡å·²é‡è½½ (02:26:43)ï¼Œç­‰å¾…ä¸‹æ¬¡ä»»åŠ¡æ‰§è¡ŒéªŒè¯æ•ˆæœ

---

## ä»»åŠ¡æ‰§è¡Œåˆ†æ

### ä»»åŠ¡ 244887942339018752 æ‰§è¡Œè®°å½•

**æ‰§è¡Œæ—¶é—´**: 2025-11-07 02:17:00 - 02:19:18

**æ‰§è¡Œç»“æœ**: âŒ å¤±è´¥ (0% æˆåŠŸç‡)

#### Step 1: Map API (âœ… æˆåŠŸ)
```
2025-11-07 02:17:16 - MapScrapeExecutor - INFO - ğŸ—ºï¸  Step 1: ä½¿ç”¨ Map API å‘ç° URL
2025-11-07 02:17:16 - MapScrapeExecutor - INFO - âœ… å‘ç° 195 ä¸ªURL
```

#### Step 2: Scrape API (âŒ 100% å¤±è´¥)
```
2025-11-07 02:17:16 - src.infrastructure.crawlers.firecrawl_adapter - INFO - çˆ¬å–å‚æ•°: formats=['markdown', 'html'], onlyMainContent=False, waitFor=1000ms
2025-11-07 02:17:17 - src.infrastructure.crawlers.firecrawl_adapter - ERROR - çˆ¬å–å¤±è´¥: https://www.thetibetpost.com/..., é”™è¯¯: Bad Request: Failed to scrape. waitFor must not exceed half of timeout
...
2025-11-07 02:19:18 - MapScrapeExecutor - INFO - ğŸ“Š Scrape å®Œæˆ: æˆåŠŸ 0, å¤±è´¥ 195, æˆåŠŸç‡ 0.0%
```

**å¤±è´¥åŸå› **: `waitFor=1000ms` å‚æ•°å€¼è¿å Firecrawl API çº¦æŸ

---

## éªŒè¯è®¡åˆ’

### è‡ªåŠ¨æ‰§è¡ŒéªŒè¯

**ä»»åŠ¡ ID**: 244887942339018752
**è°ƒåº¦è§„åˆ™**: æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ (HOURLY_1)
**ä¸‹æ¬¡æ‰§è¡Œ**: é¢„è®¡ 03:00:00

**é¢„æœŸæ—¥å¿—å†…å®¹**:
```
2025-11-07 03:00:XX - src.infrastructure.crawlers.firecrawl_adapter - INFO - çˆ¬å–å‚æ•°: formats=['markdown', 'html'], onlyMainContent=False, waitFor=500ms, timeout=30s
2025-11-07 03:0X:XX - MapScrapeExecutor - INFO - ğŸ“Š Scrape å®Œæˆ: æˆåŠŸ X, å¤±è´¥ Y, æˆåŠŸç‡ Z%
```

**æˆåŠŸæ ‡å‡†**:
1. âœ… æ—¥å¿—æ˜¾ç¤ºæ–°å‚æ•°: `waitFor=500ms, timeout=30s`
2. âœ… Scrape æˆåŠŸç‡ >0% (ä¸å†æ˜¯ 100% å¤±è´¥)
3. âœ… ç»“æœæˆåŠŸä¿å­˜åˆ°æ•°æ®åº“ (total_results >0)
4. âœ… URL å»é‡åŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

## æŠ€æœ¯ç»†èŠ‚

### Firecrawl API çº¦æŸæ¡ä»¶

**è§„åˆ™**: `waitFor < (timeout / 2)`

**è®¡ç®—ç¤ºä¾‹**:
```
# v2.1.0 (å¤±è´¥)
waitFor = 1000ms
timeout = é»˜è®¤ ~2000ms
æ£€æŸ¥: 1000ms < (2000ms / 2 = 1000ms) â†’ False âŒ

# v2.1.1 (ä¿®å¤)
waitFor = 500ms
timeout = 30000ms (30s)
æ£€æŸ¥: 500ms < (30000ms / 2 = 15000ms) â†’ True âœ…
```

### å‚æ•°ä¼ é€’è·¯å¾„

```
1. ä»»åŠ¡é…ç½® (crawl_config)
   â””â”€ wait_for: ç”¨æˆ·é…ç½®æˆ–é»˜è®¤å€¼

2. MapScrapeExecutor
   â””â”€ ä¼ é€’ wait_for åˆ° FirecrawlAdapter.scrape()

3. FirecrawlAdapter.scrape()
   â””â”€ options.get('wait_for', 500)  # v2.1.1: æ–°é»˜è®¤å€¼
   â””â”€ options.get('timeout', 30)    # v2.1.1: æ˜¾å¼ä¼ é€’

4. Firecrawl API
   â””â”€ éªŒè¯çº¦æŸ: waitFor < timeout / 2
```

---

## å‘åå…¼å®¹æ€§

### âœ… å®Œå…¨å…¼å®¹

**API å±‚ä¿®å¤**:
- æ‰€æœ‰ç°æœ‰ä»»åŠ¡ç±»å‹ä¿æŒä¸å˜
- åªæ‰©å±•äº†éªŒè¯è§„åˆ™ï¼Œå…è®¸æ–°ç±»å‹
- ä¸å½±å“ç°æœ‰ä»»åŠ¡çš„åˆ›å»ºã€æ›´æ–°ã€æŸ¥è¯¢

**Adapter å±‚ä¿®å¤**:
- é»˜è®¤å€¼æ›´æ”¹ä¸å½±å“æ˜¾å¼é…ç½®çš„ä»»åŠ¡
- ç”¨æˆ·å¯ä»¥é€šè¿‡ `crawl_config.wait_for` è¦†ç›–é»˜è®¤å€¼
- timeout å‚æ•°æ–°å¢ï¼Œä¸å½±å“ç°æœ‰é…ç½®è§£æ

---

## ç›¸å…³æ–‡æ¡£

- **API éªŒè¯ä¿®å¤**: `claudedocs/V2.1.1_API_VALIDATION_BUG_FIX.md`
- **API ä½¿ç”¨æŒ‡å—**: `docs/API_CREATE_MAP_SCRAPE_TASK.md`
- **Map+Scrape å®ç°**: `claudedocs/MAP_SCRAPE_IMPLEMENTATION_SUMMARY.md`
- **v2.1.1 å®Œæ•´æ€»ç»“**: `claudedocs/V2.1.1_IMPLEMENTATION_SUMMARY.md`

---

## å¾…åŠäº‹é¡¹

### â³ ç­‰å¾…éªŒè¯ (03:00:00)

- [ ] ç›‘æ§ä»»åŠ¡ 244887942339018752 æ‰§è¡Œæ—¥å¿—
- [ ] ç¡®è®¤æ–°å‚æ•° `waitFor=500ms, timeout=30s` ç”Ÿæ•ˆ
- [ ] éªŒè¯ Scrape æˆåŠŸç‡ >0%
- [ ] æ£€æŸ¥ç»“æœä¿å­˜åˆ°æ•°æ®åº“
- [ ] éªŒè¯ URL å»é‡åŠŸèƒ½

### ğŸ“ éªŒè¯åä»»åŠ¡

- [ ] æ›´æ–°æ­¤æ–‡æ¡£ï¼Œè®°å½•éªŒè¯ç»“æœ
- [ ] å¦‚æœæˆåŠŸï¼Œæ ‡è®° v2.1.1 ä¸º stable
- [ ] å¦‚æœå¤±è´¥ï¼Œè¿›è¡Œè¿›ä¸€æ­¥è°ƒè¯•

---

## æ€»ç»“

**ä¿®å¤çŠ¶æ€**: âœ… ä»£ç ä¿®å¤ 100% å®Œæˆ

**ä¿®å¤å†…å®¹**:
1. âœ… API éªŒè¯è§„åˆ™æ‰©å±•ï¼ˆæ”¯æŒ map_scrape_websiteï¼‰
2. âœ… Firecrawl wait_for/timeout å‚æ•°ä¼˜åŒ–
3. âœ… æ—¥å¿—å¢å¼ºï¼ˆæ˜¾ç¤º waitFor å’Œ timeoutï¼‰

**æœåŠ¡çŠ¶æ€**: âœ… è¿è¡Œæ­£å¸¸ (02:26:43 é‡è½½æˆåŠŸ)

**éªŒè¯çŠ¶æ€**: â³ ç­‰å¾…è‡ªåŠ¨æ‰§è¡ŒéªŒè¯ (é¢„è®¡ 03:00:00)

**å½±å“èŒƒå›´**: ä»…ä¿®å¤ bugï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼Œå®Œå…¨å‘åå…¼å®¹

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-07 02:26:43
**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-11-07 02:34:00
