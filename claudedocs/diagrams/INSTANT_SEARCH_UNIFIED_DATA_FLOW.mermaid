```mermaid
sequenceDiagram
    %% v2.1.0 即时+智能搜索统一架构数据流序列图

    participant User as 用户
    participant InstantService as InstantSearchService
    participant SmartService as SmartSearchService
    participant LLM as LLMService
    participant Firecrawl as FirecrawlAdapter
    participant RawRepo as InstantSearchResultRepo
    participant RawDB as instant_search_results
    participant ProcessedRepo as InstantProcessedResultRepo
    participant ProcessedDB as instant_processed_results
    participant AI as AI Service
    participant Frontend as Frontend

    %% ═══════════════════════════════════════════
    %% 即时搜索流程
    %% ═══════════════════════════════════════════

    Note over User,Frontend: 场景1: 即时搜索

    User->>InstantService: 点击"立即搜索"
    InstantService->>Firecrawl: search(query)
    Firecrawl-->>InstantService: SearchResults

    Note over InstantService: 设置 search_type="instant"
    InstantService->>RawRepo: create(result, search_type="instant")
    RawRepo->>RawDB: insert_one({search_type: "instant", ...})
    RawDB-->>RawRepo: result_id

    InstantService->>ProcessedRepo: create_pending_result(result_id, "instant")
    ProcessedRepo->>ProcessedDB: insert_one({status: "pending", search_type: "instant"})

    InstantService->>AI: notify_ai_service(result_id)
    AI-->>InstantService: 202 Accepted

    Note over AI,ProcessedDB: AI异步处理（后台）
    AI->>ProcessedRepo: update_status("processing")
    AI->>RawRepo: get_by_id(result_id)
    AI->>AI: AI翻译、总结、分类
    AI->>ProcessedRepo: save_ai_result(translated, summary, ...)
    ProcessedRepo->>ProcessedDB: update({status: "completed", ...})

    Frontend->>ProcessedRepo: get_by_task(task_id, search_type="instant")
    ProcessedDB-->>Frontend: AI增强结果

    %% ═══════════════════════════════════════════
    %% 智能搜索流程
    %% ═══════════════════════════════════════════

    Note over User,Frontend: 场景2: 智能搜索

    User->>SmartService: 输入"AI最新进展"
    SmartService->>LLM: decompose_query("AI最新进展")
    LLM-->>SmartService: ["AI机器学习", "AI深度学习", "AI应用"]

    Note over SmartService: 并发执行3个子查询

    loop 每个子查询
        SmartService->>InstantService: create_search(sub_query)
        InstantService->>Firecrawl: search(sub_query)
        Firecrawl-->>InstantService: SearchResults

        Note over InstantService: search_type="instant"（子查询）
        InstantService->>RawRepo: create(result, search_type="instant")
        RawRepo->>RawDB: insert_one({search_type: "instant", ...})
    end

    Note over SmartService: 聚合去重
    SmartService->>SmartService: aggregate_and_deduplicate()

    Note over SmartService: 设置 search_type="smart"（聚合结果）
    SmartService->>RawRepo: create(aggregated, search_type="smart")
    RawRepo->>RawDB: insert_one({search_type: "smart", composite_score, sources, ...})
    RawDB-->>RawRepo: smart_result_id

    SmartService->>ProcessedRepo: create_pending_result(smart_result_id, "smart")
    ProcessedRepo->>ProcessedDB: insert_one({status: "pending", search_type: "smart"})

    SmartService->>AI: notify_ai_service(smart_result_id)
    AI-->>SmartService: 202 Accepted

    Note over AI,ProcessedDB: AI异步处理聚合结果
    AI->>ProcessedRepo: update_status("processing")
    AI->>RawRepo: get_by_id(smart_result_id)
    AI->>AI: AI翻译、总结、分类聚合内容
    AI->>ProcessedRepo: save_ai_result(...)
    ProcessedRepo->>ProcessedDB: update({status: "completed", ...})

    Note over Frontend: 两种查看模式

    alt combined模式（聚合视图）
        Frontend->>ProcessedRepo: get_by_task(task_id, search_type="smart")
        ProcessedDB-->>Frontend: 聚合结果的AI增强数据
    else by_query模式（子查询视图）
        Frontend->>ProcessedRepo: get_by_task(sub_task_ids, search_type="instant")
        ProcessedDB-->>Frontend: 子查询结果的AI增强数据
    end
```
