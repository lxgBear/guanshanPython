# v2.1.1 API Validation Bug Fix

**ç‰ˆæœ¬**: v2.1.1 Hotfix
**ä¿®å¤æ—¥æœŸ**: 2025-11-07
**é—®é¢˜**: Pydantic éªŒè¯è§„åˆ™ç¼ºå°‘ `map_scrape_website` ä»»åŠ¡ç±»å‹

---

## ğŸ› Bug æè¿°

### é—®é¢˜ç°è±¡
å‰ç«¯åˆ›å»º `map_scrape_website` ç±»å‹ä»»åŠ¡æ—¶ï¼ŒAPI è¿”å› 422 Unprocessable Entity é”™è¯¯ã€‚

### é”™è¯¯è¯·æ±‚ç¤ºä¾‹
```json
{
  "task_type": "map_scrape_website",
  "crawl_url": "https://www.thetibetpost.com/",
  "crawl_config": {
    "only_main_content": false,
    "exclude_tags": []
  }
}
```

### é”™è¯¯å“åº”
```
HTTP/1.1 422 Unprocessable Entity
{
  "detail": [
    {
      "loc": ["body", "task_type"],
      "msg": "string does not match regex \"^(search_keyword|crawl_website|scrape_url)$\"",
      "type": "value_error.str.regex"
    }
  ]
}
```

---

## ğŸ” Root Cause Analysis

### é—®é¢˜ç¡®è®¤
1. âœ… **å‰ç«¯ä»£ç æ­£ç¡®**: æŒ‰ç…§æ–‡æ¡£å‘é€ `map_scrape_website`
2. âœ… **å‰ç«¯é…ç½®æ­£ç¡®**: `only_main_content: false`, `exclude_tags: []`
3. âŒ **åç«¯éªŒè¯è§„åˆ™æœ‰ bug**: éªŒè¯ pattern å’Œæ–‡æ¡£ä¸ä¸€è‡´

### ä»£ç åˆ†æ

**Domain å±‚ï¼ˆâœ… æ­£ç¡®ï¼‰**:
```python
# src/core/domain/entities/search_task.py
class TaskType(Enum):
    SEARCH_KEYWORD = "search_keyword"
    CRAWL_WEBSITE = "crawl_website"
    SCRAPE_URL = "scrape_url"
    MAP_SCRAPE_WEBSITE = "map_scrape_website"  # âœ… å·²å®šä¹‰
```

**API å±‚ï¼ˆâŒ é”™è¯¯ï¼‰**:
```python
# src/api/v1/endpoints/search_tasks_frontend.py (ä¿®å¤å‰)
task_type: Optional[str] = Field(
    None,
    pattern="^(search_keyword|crawl_website|scrape_url)$"  # âŒ ç¼ºå°‘ map_scrape_website
)
```

**é”™è¯¯ä½ç½®**:
- `SearchTaskCreate.task_type` (Line 58-62)
- `SearchTaskUpdate.task_type` (Line 150-154)
- `SearchTaskResponse.task_type` (Line 177-178)
- `task_to_response()` ä¸­çš„ `task_mode_map` (Line 228-233)

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤å†…å®¹

#### 1. æ›´æ–° Pydantic éªŒè¯è§„åˆ™

**SearchTaskCreate** (åˆ›å»ºä»»åŠ¡è¯·æ±‚):
```python
# v2.0.0 æ–°å¢ï¼šä»»åŠ¡ç±»å‹ | v2.1.1: æ–°å¢ map_scrape_website
task_type: Optional[str] = Field(
    None,
    description="ä»»åŠ¡ç±»å‹ï¼šsearch_keywordï¼ˆå…³é”®è¯æœç´¢ï¼‰ã€crawl_websiteï¼ˆç½‘ç«™çˆ¬å–ï¼‰ã€scrape_urlï¼ˆå•é¡µé¢çˆ¬å–ï¼‰ã€map_scrape_websiteï¼ˆMap+Scrapeç»„åˆï¼‰",
    pattern="^(search_keyword|crawl_website|scrape_url|map_scrape_website)$"  # âœ… æ·»åŠ  map_scrape_website
)
```

**SearchTaskUpdate** (æ›´æ–°ä»»åŠ¡è¯·æ±‚):
```python
# v2.0.0 æ–°å¢ï¼šä»»åŠ¡ç±»å‹ | v2.1.1: æ–°å¢ map_scrape_website
task_type: Optional[str] = Field(
    None,
    description="ä»»åŠ¡ç±»å‹ï¼šsearch_keywordã€crawl_websiteã€scrape_urlã€map_scrape_website",
    pattern="^(search_keyword|crawl_website|scrape_url|map_scrape_website)$"  # âœ… æ·»åŠ  map_scrape_website
)
```

**SearchTaskResponse** (ä»»åŠ¡å“åº”):
```python
# v2.0.0 æ–°å¢ï¼šä»»åŠ¡ç±»å‹ | v2.1.1: æ–°å¢ map_scrape_website
task_type: str = Field(..., description="ä»»åŠ¡ç±»å‹ï¼šsearch_keywordã€crawl_websiteã€scrape_urlã€map_scrape_website")
task_mode: str = Field(..., description="ä»»åŠ¡æ¨¡å¼æè¿°ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰")
```

#### 2. æ›´æ–°ä»»åŠ¡æ¨¡å¼æ˜ å°„

**task_to_response() å‡½æ•°**:
```python
# è·å–ä»»åŠ¡æ¨¡å¼æè¿°ï¼ˆv2.1.1: æ–°å¢ map_scrape_websiteï¼‰
task_mode_map = {
    "search_keyword": "å…³é”®è¯æœç´¢ + è¯¦æƒ…é¡µçˆ¬å–",
    "crawl_website": "ç½‘ç«™é€’å½’çˆ¬å–",
    "scrape_url": "å•é¡µé¢çˆ¬å–",
    "map_scrape_website": "Map + Scrape ç»„åˆæ¨¡å¼"  # âœ… æ–°å¢
}
task_mode = task_mode_map.get(task_type.value, task_type.value)
```

---

## ğŸ“Š éªŒè¯æµ‹è¯•

### æµ‹è¯•æ–¹æ³•

#### 1. åˆ›å»º Map+Scrape ä»»åŠ¡
```bash
curl -X POST http://localhost:8000/api/v1/search-tasks \
  -H "Content-Type: application/json" \
  -d '{
    "name": "è¥¿è—é‚®æŠ¥ Map+Scrape",
    "description": "ä½¿ç”¨ Map+Scrape æ¨¡å¼çˆ¬å–è¥¿è—é‚®æŠ¥ç½‘ç«™",
    "crawl_url": "https://www.thetibetpost.com/",
    "task_type": "map_scrape_website",
    "crawl_config": {
      "limit": 10,
      "max_depth": 2,
      "only_main_content": false,
      "exclude_tags": [],
      "wait_for": 3000,
      "timeout": 300,
      "poll_interval": 10,
      "map_limit": 5000,
      "max_concurrent_scrapes": 5,
      "scrape_delay": 0.5,
      "enable_dedup": true
    },
    "schedule_interval": "HOURLY_1",
    "is_active": true,
    "execute_immediately": true
  }'
```

#### é¢„æœŸå“åº” (HTTP 201 Created):
```json
{
  "id": "244879584026255360",
  "name": "è¥¿è—é‚®æŠ¥ Map+Scrape",
  "task_type": "map_scrape_website",
  "task_mode": "Map + Scrape ç»„åˆæ¨¡å¼",
  "crawl_url": "https://www.thetibetpost.com/",
  "crawl_config": {
    "only_main_content": false,
    "exclude_tags": [],
    "enable_dedup": true
  },
  "is_active": true,
  "status": "active"
}
```

#### 2. éªŒè¯ä»»åŠ¡ç±»å‹æšä¸¾
```bash
# æµ‹è¯•æ‰€æœ‰ä»»åŠ¡ç±»å‹éƒ½èƒ½é€šè¿‡éªŒè¯
curl -X POST http://localhost:8000/api/v1/search-tasks \
  -H "Content-Type: application/json" \
  -d '{"task_type": "search_keyword", ...}'    # âœ… åº”è¯¥æˆåŠŸ

curl -X POST http://localhost:8000/api/v1/search-tasks \
  -H "Content-Type: application/json" \
  -d '{"task_type": "crawl_website", ...}'     # âœ… åº”è¯¥æˆåŠŸ

curl -X POST http://localhost:8000/api/v1/search-tasks \
  -H "Content-Type: application/json" \
  -d '{"task_type": "scrape_url", ...}'        # âœ… åº”è¯¥æˆåŠŸ

curl -X POST http://localhost:8000/api/v1/search-tasks \
  -H "Content-Type: application/json" \
  -d '{"task_type": "map_scrape_website", ...}' # âœ… åº”è¯¥æˆåŠŸ

curl -X POST http://localhost:8000/api/v1/search-tasks \
  -H "Content-Type: application/json" \
  -d '{"task_type": "invalid_type", ...}'      # âŒ åº”è¯¥è¿”å› 422
```

---

## ğŸ—‚ï¸ ä¿®æ”¹çš„æ–‡ä»¶

### `/Users/lanxionggao/Documents/guanshanPython/src/api/v1/endpoints/search_tasks_frontend.py`

**å˜æ›´å†…å®¹**:
1. Line 57-62: `SearchTaskCreate.task_type` - æ·»åŠ  `map_scrape_website` åˆ° pattern
2. Line 149-154: `SearchTaskUpdate.task_type` - æ·»åŠ  `map_scrape_website` åˆ° pattern
3. Line 176-178: `SearchTaskResponse.task_type` - æ›´æ–° description åŒ…å« `map_scrape_website`
4. Line 227-233: `task_to_response()` - æ·»åŠ  `map_scrape_website` åˆ° task_mode_map

---

## ğŸ”„ å‘åå…¼å®¹æ€§

### âœ… å®Œå…¨å…¼å®¹
- æ‰€æœ‰ç°æœ‰ä»»åŠ¡ç±»å‹ï¼ˆ`search_keyword`, `crawl_website`, `scrape_url`ï¼‰ä¿æŒä¸å˜
- åªæ˜¯æ‰©å±•äº†éªŒè¯è§„åˆ™ï¼Œå…è®¸æ–°çš„ `map_scrape_website` ç±»å‹
- ä¸å½±å“ç°æœ‰ä»»åŠ¡çš„åˆ›å»ºã€æ›´æ–°ã€æŸ¥è¯¢åŠŸèƒ½
- å‰ç«¯ç°æœ‰åŠŸèƒ½å®Œå…¨ä¸å—å½±å“

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- **å®ç°æ–‡æ¡£**: `claudedocs/V2.1.1_IMPLEMENTATION_SUMMARY.md`
- **API æ–‡æ¡£**: `docs/API_CREATE_MAP_SCRAPE_TASK.md`
- **Map+Scrape å®ç°**: `claudedocs/MAP_SCRAPE_IMPLEMENTATION_SUMMARY.md`

---

## âœ… ä¿®å¤å®Œæˆæ¸…å•

- [x] æ›´æ–° `SearchTaskCreate.task_type` éªŒè¯è§„åˆ™
- [x] æ›´æ–° `SearchTaskUpdate.task_type` éªŒè¯è§„åˆ™
- [x] æ›´æ–° `SearchTaskResponse.task_type` æè¿°
- [x] æ›´æ–° `task_mode_map` æ·»åŠ æ–°ä»»åŠ¡ç±»å‹æ˜ å°„
- [x] æœåŠ¡è‡ªåŠ¨é‡è½½éªŒè¯
- [x] åˆ›å»ºä¿®å¤æ–‡æ¡£

**ä¿®å¤çŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆ
**æœåŠ¡çŠ¶æ€**: âœ… è¿è¡Œæ­£å¸¸ (02:13:58)
**éªŒè¯çŠ¶æ€**: âœ… å¯ä»¥æ¥å— map_scrape_website ä»»åŠ¡åˆ›å»ºè¯·æ±‚

---

## ğŸ¯ æ€»ç»“

### é—®é¢˜æœ¬è´¨
Backend API validation å’Œ Domain entity å®šä¹‰ä¸ä¸€è‡´ï¼Œå¯¼è‡´åˆæ³•çš„ `map_scrape_website` ä»»åŠ¡ç±»å‹è¢« Pydantic éªŒè¯æ‹’ç»ã€‚

### ä¿®å¤æœ¬è´¨
åŒæ­¥ API å±‚çš„ Pydantic éªŒè¯è§„åˆ™ä¸ Domain å±‚çš„ TaskType æšä¸¾å®šä¹‰ï¼Œç¡®ä¿æ‰€æœ‰ 4 ç§ä»»åŠ¡ç±»å‹éƒ½èƒ½é€šè¿‡éªŒè¯ã€‚

### å½±å“èŒƒå›´
**ä»…å½±å“ API éªŒè¯å±‚**ï¼ŒDomain å±‚ã€Service å±‚ã€Executor å±‚å‡å·²æ­£ç¡®å®ç° `map_scrape_website` æ”¯æŒï¼Œæ­¤ä¿®å¤åªæ˜¯ä¿®æ­£äº†å…¥å£éªŒè¯è§„åˆ™ã€‚
