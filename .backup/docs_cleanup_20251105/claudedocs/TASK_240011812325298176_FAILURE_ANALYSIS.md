# æ™ºèƒ½æœç´¢ä»»åŠ¡å¤±è´¥åˆ†ææŠ¥å‘Š

**ä»»åŠ¡ID**: `240011812325298176`
**åˆ†ææ—¶é—´**: 2025-10-24 15:33
**åˆ†æäººå‘˜**: Claude Code Backend Analyst

---

## æ‰§è¡Œæ¦‚å†µ

### åŸºæœ¬ä¿¡æ¯
- **ä»»åŠ¡åç§°**: æœç´¢_The Military Intelli_1024_1521
- **æœ€ç»ˆçŠ¶æ€**: `partial_success` âš ï¸ (éƒ¨åˆ†æˆåŠŸï¼Œéå®Œå…¨å¤±è´¥)
- **åŸå§‹æŸ¥è¯¢**: "The Military Intelligence Training School and Depot (MINTSD) located at Pune is a premier institution..."
- **åˆ›å»ºæ—¶é—´**: 2025-10-24 07:21:15
- **å¼€å§‹æ—¶é—´**: 2025-10-24 07:21:46
- **å®Œæˆæ—¶é—´**: 2025-10-24 07:22:16
- **æ€»æ‰§è¡Œæ—¶é—´**: 30,544ms (~30.5ç§’)

### æ‰§è¡Œç»Ÿè®¡
```
æ€»å­æœç´¢æ•°:     4
æˆåŠŸ:          3 âœ…
å¤±è´¥:          1 âŒ
æˆåŠŸç‡:        75%
æ€»ç»“æœæ•°(å»é‡): 0
```

---

## å¤±è´¥åŸå› åˆ†æ

### ğŸ” æ ¹æœ¬åŸå› 

**å­æœç´¢ #2 è¶…æ—¶å¤±è´¥**

| å­—æ®µ | å€¼ |
|-----|---|
| å­ä»»åŠ¡ID | `240012069771677696` |
| æŸ¥è¯¢ | "MINTSD Pune training courses content" |
| çŠ¶æ€ | `failed` |
| é”™è¯¯ä¿¡æ¯ | "è¯·æ±‚è¶…æ—¶" |
| æ‰§è¡Œæ—¶é—´ | 0ms (æœªæ‰§è¡Œå®Œæˆ) |

### ğŸ“Š å…¶ä»–å­æœç´¢çŠ¶æ€

#### âœ… å­æœç´¢ #1 - æˆåŠŸ
- **ä»»åŠ¡ID**: `240011941845405696`
- **æŸ¥è¯¢**: "lt gen DP Singh MINTSD commander information"
- **çŠ¶æ€**: `completed`
- **ç»“æœæ•°**: 0
- **æ‰§è¡Œæ—¶é—´**: 10,154ms

#### âœ… å­æœç´¢ #3 - æˆåŠŸ
- **ä»»åŠ¡ID**: `240011941849600000`
- **æŸ¥è¯¢**: "MINTSD intelligence training programs"
- **çŠ¶æ€**: `completed`
- **ç»“æœæ•°**: 0
- **æ‰§è¡Œæ—¶é—´**: 8,992ms

#### âœ… å­æœç´¢ #4 - æˆåŠŸ
- **ä»»åŠ¡ID**: `240011941849600002`
- **æŸ¥è¯¢**: "MINTSD intelligence tasks and operations"
- **çŠ¶æ€**: `completed`
- **ç»“æœæ•°**: 0
- **æ‰§è¡Œæ—¶é—´**: 10,530ms

---

## æŠ€æœ¯åˆ†æ

### è¶…æ—¶é…ç½®æ£€æŸ¥

**å½“å‰é…ç½®** (`.env`):
```bash
FIRECRAWL_TIMEOUT=30  # 30ç§’è¶…æ—¶
FIRECRAWL_MAX_RETRIES=3  # æœ€å¤šé‡è¯•3æ¬¡
```

### Firecrawl é€‚é…å™¨é‡è¯•æœºåˆ¶

**ä»£ç ä½ç½®**: `src/infrastructure/search/firecrawl_search_adapter.py:54-59`

```python
@retry(
    stop=stop_after_attempt(3),       # æœ€å¤š3æ¬¡å°è¯•
    wait=wait_fixed(480),              # æ¯æ¬¡é‡è¯•ç­‰å¾…8åˆ†é’Ÿ (480ç§’)
    retry=retry_if_exception_type((httpx.ConnectError, httpx.TimeoutException, httpx.HTTPStatusError))
)
```

**é‡è¯•ç­–ç•¥**:
- åˆæ¬¡è¯·æ±‚å¤±è´¥ â†’ ç­‰å¾… 8 åˆ†é’Ÿ â†’ ç¬¬ 1 æ¬¡é‡è¯•
- ç¬¬ 1 æ¬¡é‡è¯•å¤±è´¥ â†’ ç­‰å¾… 8 åˆ†é’Ÿ â†’ ç¬¬ 2 æ¬¡é‡è¯•
- ç¬¬ 2 æ¬¡é‡è¯•å¤±è´¥ â†’ æ”¾å¼ƒ

### è¶…æ—¶åˆ¤æ–­é€»è¾‘

**ä»£ç ä½ç½®**: `src/infrastructure/search/firecrawl_search_adapter.py:160-163`

```python
except httpx.TimeoutException as e:
    error_msg = f"è¯·æ±‚è¶…æ—¶: {str(e)}"
    logger.error(f"âŒ {error_msg}")
    batch.set_error(error_msg)
```

### HTTP å®¢æˆ·ç«¯é…ç½®

**ä»£ç ä½ç½®**: `src/infrastructure/search/firecrawl_search_adapter.py:107-110`

```python
client_config = {
    "proxies": {},  # ç¦ç”¨ä»£ç†
    "timeout": config.get('timeout', 30)  # 30ç§’è¶…æ—¶
}
```

---

## å¤±è´¥åœºæ™¯æ¨æ–­

### å¯èƒ½çš„å¤±è´¥åœºæ™¯

#### åœºæ™¯1: Firecrawl API å“åº”æ…¢ (æœ€å¯èƒ½)
- **åŸå› **: æŸ¥è¯¢ "MINTSD Pune training courses content" å¯èƒ½éœ€è¦æŠ“å–å¤§é‡ç½‘é¡µå†…å®¹
- **è¡¨ç°**: 30ç§’å†…APIæœªè¿”å›å“åº”
- **è¯æ®**: å…¶ä»–3ä¸ªæŸ¥è¯¢åœ¨8-10ç§’å†…å®Œæˆï¼Œè¯´æ˜ç½‘ç»œæ­£å¸¸

#### åœºæ™¯2: ç›®æ ‡ç½‘ç«™å“åº”æ…¢
- **åŸå› **: Firecrawl åœ¨æŠ“å–åŒ…å« "Pune training courses" çš„ç½‘ç«™æ—¶ï¼Œç›®æ ‡ç½‘ç«™å“åº”æ…¢
- **è¡¨ç°**: Firecrawl ç­‰å¾…ç›®æ ‡ç½‘ç«™ï¼Œå¯¼è‡´æ•´ä½“è¶…æ—¶

#### åœºæ™¯3: Firecrawl API ä¸´æ—¶è¿‡è½½
- **åŸå› **: APIæœåŠ¡å™¨ä¸´æ—¶è´Ÿè½½é«˜
- **è¡¨ç°**: è¯·æ±‚æ’é˜Ÿæˆ–å¤„ç†æ…¢

#### åœºæ™¯4: ç½‘ç»œé—®é¢˜
- **åŸå› **: æœ¬åœ°ç½‘ç»œæˆ–ä¸­é—´è·¯ç”±é—®é¢˜
- **å¯èƒ½æ€§**: è¾ƒä½ï¼ˆå…¶ä»–3ä¸ªæŸ¥è¯¢æˆåŠŸï¼‰

---

## å½±å“è¯„ä¼°

### ä¸šåŠ¡å½±å“
- âœ… **ä»»åŠ¡æœªå®Œå…¨å¤±è´¥**: çŠ¶æ€ä¸º `partial_success`ï¼Œä¸æ˜¯ `failed`
- âœ… **75%æˆåŠŸç‡**: 4ä¸ªå­æœç´¢ä¸­3ä¸ªæˆåŠŸ
- âš ï¸ **æ— æœ‰æ•ˆç»“æœ**: å³ä½¿æˆåŠŸçš„3ä¸ªå­æœç´¢ä¹Ÿè¿”å›0ç»“æœï¼ˆå¯èƒ½æŸ¥è¯¢è¿‡äºå…·ä½“ï¼‰
- âš ï¸ **ç”¨æˆ·ä½“éªŒå½±å“**: éƒ¨åˆ†æˆåŠŸå¯èƒ½é€ æˆç”¨æˆ·å›°æƒ‘

### ç³»ç»Ÿå½±å“
- âœ… **ç§¯åˆ†æœªè¿‡åº¦æ¶ˆè€—**: è¶…æ—¶çš„å­æœç´¢æœªæ¶ˆè€—ç§¯åˆ†
- âœ… **æ•°æ®ä¸€è‡´æ€§**: ä»»åŠ¡çŠ¶æ€æ­£ç¡®æ ‡è®°ä¸º `partial_success`
- âœ… **é‡è¯•æœºåˆ¶æœªè§¦å‘**: 30ç§’è¶…æ—¶åœ¨ç¬¬ä¸€æ¬¡å°è¯•å°±è§¦å‘ï¼Œæœªè¿›å…¥8åˆ†é’Ÿé‡è¯•

---

## æ¨èè§£å†³æ–¹æ¡ˆ

### ğŸ¯ æ–¹æ¡ˆ1: è°ƒæ•´è¶…æ—¶é…ç½® (æ¨è)

**è°ƒæ•´ç†ç”±**:
- Firecrawl API éœ€è¦çˆ¬å–ç½‘é¡µå†…å®¹ï¼Œ30ç§’å¯èƒ½ä¸å¤Ÿ
- å…¶ä»–æˆåŠŸçš„å­æœç´¢ä¹Ÿéœ€è¦8-10ç§’
- å¤æ‚æŸ¥è¯¢å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´

**å»ºè®®é…ç½®**:
```bash
# .env
FIRECRAWL_TIMEOUT=60  # å¢åŠ åˆ°60ç§’
```

**æƒè¡¡**:
- âœ… æé«˜æˆåŠŸç‡
- âš ï¸ å¢åŠ ç”¨æˆ·ç­‰å¾…æ—¶é—´
- âš ï¸ å¯èƒ½å¢åŠ APIæˆæœ¬ï¼ˆå¦‚æœAPIæŒ‰æ—¶é—´è®¡è´¹ï¼‰

### ğŸ¯ æ–¹æ¡ˆ2: å®ç°å­æœç´¢é‡è¯•æœºåˆ¶

**å½“å‰çŠ¶æ€**: åªæœ‰Firecrawl APIçº§åˆ«çš„é‡è¯•ï¼Œæ²¡æœ‰å­æœç´¢çº§åˆ«çš„é‡è¯•

**å®ç°æ–¹æ¡ˆ**:
ä¿®æ”¹ `src/services/smart_search_service.py:308-403` ä¸­çš„ `_execute_concurrent_searches` æ–¹æ³•ï¼Œæ·»åŠ å­æœç´¢çº§åˆ«çš„é‡è¯•:

```python
async def search_with_semaphore(query: str, index: int, max_retries: int = 1):
    """å¸¦å¹¶å‘æ§åˆ¶å’Œé‡è¯•çš„æœç´¢"""
    async with semaphore:
        for attempt in range(max_retries + 1):
            try:
                logger.info(f"[{index+1}/{len(queries)}] å¼€å§‹æœç´¢ (å°è¯• {attempt+1}/{max_retries+1}): {query}")

                task = await self.instant_search_service.create_and_execute_search(
                    name=f"å­æœç´¢: {query}",
                    query=query,
                    search_config=search_config,
                    created_by="smart_search_system"
                )

                if task.status.value == "completed":
                    return task
                elif attempt < max_retries:
                    logger.warning(f"[{index+1}/{len(queries)}] æœç´¢å¤±è´¥ï¼Œ{30}ç§’åé‡è¯•...")
                    await asyncio.sleep(30)

            except Exception as e:
                if attempt < max_retries:
                    logger.warning(f"[{index+1}/{len(queries)}] å¼‚å¸¸ï¼Œ{30}ç§’åé‡è¯•: {e}")
                    await asyncio.sleep(30)
                else:
                    logger.error(f"[{index+1}/{len(queries)}] æœç´¢å¤±è´¥ (å·²é‡è¯•{max_retries}æ¬¡): {e}")
                    # è¿”å›å¤±è´¥ä»»åŠ¡
                    ...
```

**ä¼˜åŠ¿**:
- âœ… æé«˜å¯é æ€§
- âœ… ä¸´æ—¶ç½‘ç»œé—®é¢˜å¯ä»¥è‡ªåŠ¨æ¢å¤
- âš ï¸ å¢åŠ æ€»æ‰§è¡Œæ—¶é—´

### ğŸ¯ æ–¹æ¡ˆ3: ä¼˜åŒ–æŸ¥è¯¢åˆ†è§£ç­–ç•¥

**é—®é¢˜**: æŸ¥è¯¢ "MINTSD Pune training courses content" å¯èƒ½è¿‡äºå…·ä½“ï¼Œå¯¼è‡´éœ€è¦çˆ¬å–å¤§é‡é¡µé¢

**å»ºè®®**: åœ¨LLMæŸ¥è¯¢åˆ†è§£é˜¶æ®µï¼Œä¼˜åŒ–æç¤ºè¯ï¼Œè®©LLMç”Ÿæˆæ›´ç®€æ´çš„æŸ¥è¯¢:

```python
# src/infrastructure/llm/openai_service.py
# åœ¨æç¤ºè¯ä¸­æ·»åŠ :
"ç”Ÿæˆçš„å­æŸ¥è¯¢åº”è¯¥ç®€æ´ï¼Œé¿å…è¿‡é•¿çš„æè¿°æ€§çŸ­è¯­ã€‚
ä¼˜å…ˆä½¿ç”¨å…³é”®è¯ç»„åˆè€Œéå®Œæ•´å¥å­ã€‚"
```

### ğŸ¯ æ–¹æ¡ˆ4: å®ç°è¶…æ—¶ç›‘æ§å’Œå‘Šè­¦

**å»ºè®®**: æ·»åŠ ç›‘æ§é€»è¾‘ï¼Œç»Ÿè®¡è¶…æ—¶ç‡:

```python
# åœ¨ SmartSearchService ä¸­æ·»åŠ :
self.timeout_count = 0
self.total_searches = 0

# åœ¨æ¯æ¬¡æœç´¢å:
if task.status == InstantSearchStatus.FAILED and "è¶…æ—¶" in task.error_message:
    self.timeout_count += 1

timeout_rate = self.timeout_count / self.total_searches
if timeout_rate > 0.1:  # è¶…æ—¶ç‡ > 10%
    logger.warning(f"âš ï¸ è¶…æ—¶ç‡è¿‡é«˜: {timeout_rate:.1%}, è€ƒè™‘å¢åŠ FIRECRAWL_TIMEOUT")
```

---

## ç»“è®º

### ä»»åŠ¡çŠ¶æ€æ€»ç»“
- âœ… **ç³»ç»Ÿè¿è¡Œæ­£å¸¸**: çŠ¶æ€è¿½è¸ªã€é”™è¯¯å¤„ç†ã€å¹¶å‘æ‰§è¡Œå‡å·¥ä½œæ­£å¸¸
- âš ï¸ **è¶…æ—¶é…ç½®éœ€ä¼˜åŒ–**: 30ç§’å¯èƒ½ä¸è¶³ä»¥å¤„ç†å¤æ‚æŸ¥è¯¢
- âš ï¸ **æŸ¥è¯¢æ— ç»“æœ**: å³ä½¿æˆåŠŸçš„å­æœç´¢ä¹Ÿæ²¡æœ‰è¿”å›ç»“æœï¼Œå¯èƒ½éœ€è¦ä¼˜åŒ–æŸ¥è¯¢ç­–ç•¥

### ä¼˜å…ˆçº§å»ºè®®

| ä¼˜å…ˆçº§ | æ–¹æ¡ˆ | å®æ–½éš¾åº¦ | å½±å“èŒƒå›´ |
|-------|------|---------|---------|
| P0 | æ–¹æ¡ˆ1: è°ƒæ•´è¶…æ—¶åˆ°60ç§’ | ä½ | ç«‹å³ç”Ÿæ•ˆ |
| P1 | æ–¹æ¡ˆ4: æ·»åŠ è¶…æ—¶ç›‘æ§ | ä¸­ | é•¿æœŸä¼˜åŒ– |
| P2 | æ–¹æ¡ˆ2: å­æœç´¢é‡è¯• | é«˜ | æé«˜å¯é æ€§ |
| P3 | æ–¹æ¡ˆ3: ä¼˜åŒ–LLMæç¤ºè¯ | ä¸­ | æé«˜æœç´¢è´¨é‡ |

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ‰§è¡Œ** (5åˆ†é’Ÿ):
   ```bash
   # ä¿®æ”¹ .env
   FIRECRAWL_TIMEOUT=60

   # é‡å¯æœåŠ¡
   # æœåŠ¡ä¼šè‡ªåŠ¨åŠ è½½æ–°é…ç½®
   ```

2. **ç›‘æ§è§‚å¯Ÿ** (1å‘¨):
   - è§‚å¯Ÿè¶…æ—¶ç‡å˜åŒ–
   - æ”¶é›†æ›´å¤šå¤±è´¥æ¡ˆä¾‹æ•°æ®
   - è¯„ä¼°60ç§’è¶…æ—¶çš„æ•ˆæœ

3. **æ ¹æ®æ•°æ®å†³å®š** (1å‘¨å):
   - å¦‚æœè¶…æ—¶ç‡ä»é«˜ (>5%) â†’ å®æ–½æ–¹æ¡ˆ2 (å­æœç´¢é‡è¯•)
   - å¦‚æœæŸ¥è¯¢è´¨é‡å·® â†’ å®æ–½æ–¹æ¡ˆ3 (ä¼˜åŒ–LLM)
   - å¦‚æœä¸€åˆ‡æ­£å¸¸ â†’ ä¿æŒå½“å‰é…ç½®

---

## é™„å½•

### ç›¸å…³æ—¥å¿—ç‰‡æ®µ

```
2025-10-24 15:21:15 - åˆ›å»ºæ™ºèƒ½æœç´¢ä»»åŠ¡æˆåŠŸ (ID: 240011812325298176)
2025-10-24 15:21:15 - è°ƒç”¨LLMåˆ†è§£æŸ¥è¯¢...
2025-10-24 15:21:39 - æŸ¥è¯¢åˆ†è§£å®Œæˆ: 4ä¸ªå­æŸ¥è¯¢
2025-10-24 15:21:46 - å¼€å§‹æ‰§è¡Œæ™ºèƒ½æœç´¢: 4ä¸ªå­æŸ¥è¯¢
2025-10-24 15:21:46 - å¼€å§‹å¹¶å‘æ‰§è¡Œ 4 ä¸ªå­æœç´¢, max_concurrent=5
2025-10-24 15:22:16 - âŒ è¯·æ±‚è¶…æ—¶
2025-10-24 15:22:16 - å¹¶å‘æœç´¢å®Œæˆ: æ€»æ•°=4, æˆåŠŸ=3, å¤±è´¥=1
2025-10-24 15:22:16 - æ™ºèƒ½æœç´¢å®Œæˆ: çŠ¶æ€=partial_success, æ€»ç»“æœ=0, è€—æ—¶=30544ms
```

### ç›¸å…³ä»£ç æ–‡ä»¶

1. `src/services/smart_search_service.py` - æ™ºèƒ½æœç´¢æœåŠ¡
2. `src/infrastructure/search/firecrawl_search_adapter.py` - Firecrawl APIé€‚é…å™¨
3. `src/core/domain/entities/smart_search_task.py` - ä»»åŠ¡å®ä½“
4. `.env` - é…ç½®æ–‡ä»¶

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-24 15:33
**åˆ†æå·¥å…·**: Claude Code v4.5 + MongoDBæŸ¥è¯¢
