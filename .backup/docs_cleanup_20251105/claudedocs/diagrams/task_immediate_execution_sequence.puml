@startuml 定时搜索任务首次立即执行流程
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

title 定时搜索任务首次创建立即执行流程 (v2.0.1)

actor "前端用户" as Client
participant "API 端点\nsearch_tasks_frontend.py" as API
participant "SearchTask\n实体" as Entity
participant "TaskRepository\n仓储层" as Repo
database "MongoDB\nsearch_tasks" as DB
participant "TaskScheduler\n调度器" as Scheduler
participant "后台执行\n(异步)" as AsyncExec

== 1. 创建任务 ==
Client -> API: POST /api/v1/search-tasks\n{\n  name: "新任务",\n  query: "Myanmar",\n  execute_immediately: true,\n  is_active: true\n}
activate API

API -> Entity: 创建 SearchTask 实体
activate Entity
Entity --> API: task 实体对象
deactivate Entity

API -> Repo: create(task)
activate Repo
Repo -> DB: 插入任务文档
activate DB
DB --> Repo: 插入成功
deactivate DB
Repo --> API: 保存成功
deactivate Repo

note over API: 记录日志：任务已创建

== 2. 首次立即执行（异步） ==
alt execute_immediately == True AND is_active == True
    API -> Scheduler: 获取调度器实例
    activate Scheduler

    alt 调度器正在运行
        API -> AsyncExec: asyncio.create_task(\n  execute_task_now(task_id)\n)
        activate AsyncExec
        note over AsyncExec: 异步执行，不阻塞 API 响应

        note over API: ✅ 记录日志：\n已触发首次立即执行

        API --> Client: 200 OK\n{\n  id: "task_id",\n  status: "active",\n  ...\n}
        deactivate API

        == 3. 后台执行（不阻塞 API） ==
        AsyncExec -> Scheduler: execute_task_now(task_id)
        activate Scheduler #LightBlue

        Scheduler -> Repo: get_by_id(task_id)
        Repo -> DB: 查询任务
        DB --> Repo: 任务数据
        Repo --> Scheduler: task 对象

        Scheduler -> Scheduler: _execute_search_task(task_id)
        note over Scheduler: 执行搜索爬取\n处理结果\n保存到 processed_results_new

        Scheduler -> Repo: update(task)\n更新执行统计
        Repo -> DB: 更新任务文档
        DB --> Repo: 更新成功

        Scheduler --> AsyncExec: 执行完成\n{\n  status: "completed",\n  execution_count: 1\n}
        deactivate Scheduler
        deactivate AsyncExec

    else 调度器未运行
        note over API: ⚠️ 记录警告：\n调度器未运行，跳过首次执行

        API --> Client: 200 OK\n{\n  id: "task_id",\n  status: "active",\n  ...\n}
        deactivate API
    end
    deactivate Scheduler

else execute_immediately == False
    note over API: 跳过首次执行\n仅创建定时任务

    API --> Client: 200 OK\n{\n  id: "task_id",\n  status: "active",\n  ...\n}
    deactivate API
end

== 4. 定时调度（后续执行） ==
note over Scheduler: 任务已加入定时调度列表\n根据 schedule_interval 定期执行

@enduml
