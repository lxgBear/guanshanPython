# Bugä¿®å¤æ–‡æ¡£ - åŸå§‹æ•°æ®ç±»å‹æ£€æµ‹å’Œæ—¥å¿—å¢å¼º

**ä¿®å¤æ—¥æœŸ**: 2025-10-31
**ç‰ˆæœ¬**: v1.4.2
**ä¸¥é‡ç¨‹åº¦**: é«˜
**å½±å“èŒƒå›´**: æ•°æ®æºç®¡ç†API - æ·»åŠ /ç§»é™¤åŸå§‹æ•°æ®ç«¯ç‚¹

**ğŸ”” é‡è¦æç¤º**: æœ¬æ–‡æ¡£æè¿°çš„æ™ºèƒ½IDæ£€æµ‹æ–¹æ¡ˆå·²è¢« **v1.5.0 IDç³»ç»Ÿç»Ÿä¸€** å–ä»£ã€‚
- v1.4.2 ä½¿ç”¨æ™ºèƒ½æ£€æµ‹ä½œä¸ºä¸´æ—¶ä¿®å¤æ–¹æ¡ˆ
- v1.5.0 ç»Ÿä¸€æ‰€æœ‰IDä¸ºé›ªèŠ±ç®—æ³•ï¼Œä»æ ¹æœ¬ä¸Šè§£å†³äº†é—®é¢˜
- è¯¦è§ï¼š`frontend-types/ID_SYSTEM_UNIFICATION_v1.5.0.md`

---

## é—®é¢˜æ¦‚è¿°

### é—®é¢˜1ï¼šraw-dataæ¥å£400é”™è¯¯æ— æ—¥å¿—è¯¦æƒ…

**ç°è±¡**: `/api/v1/data-sources/{id}/raw-data` ç«¯ç‚¹è¿”å› 400 é”™è¯¯ï¼Œä½†æ—¥å¿—ä¸­åªæœ‰ HTTP çŠ¶æ€ç ï¼Œæ— é”™è¯¯è¯¦æƒ…ã€‚

**å½±å“**:
- ç”Ÿäº§ç¯å¢ƒå‡ºç°8æ¬¡è¿ç»­400é”™è¯¯ï¼ˆ2025-10-31 14:50:54ï¼‰
- æ— æ³•å®šä½å…·ä½“é”™è¯¯åŸå› 
- è¿ç»´å’Œå¼€å‘è°ƒè¯•å›°éš¾

**æ ¹æœ¬åŸå› **:
- API ç«¯ç‚¹æ•è· `ValueError` åç›´æ¥æŠ›å‡º `HTTPException`
- æœªåœ¨æŠ›å‡ºå¼‚å¸¸å‰è®°å½•æ—¥å¿—
- ä»£ç ä½ç½®ï¼š`src/api/v1/endpoints/data_source_management.py` ç¬¬237-238è¡Œ

### é—®é¢˜2ï¼šå‰ç«¯data_typeä¸data_idä¸åŒ¹é…

**ç°è±¡**: å‰ç«¯å‘é€è¯·æ±‚æ—¶ï¼Œ`data_type` å­—æ®µä¸ `data_id` æ ¼å¼ä¸ä¸€è‡´ã€‚

**é”™è¯¯è¯·æ±‚ç¤ºä¾‹**:
```json
{
  "data_id": "7c2a1e9e-e92e-4325-bd81-c8c3e29df0c5",  // UUIDæ ¼å¼
  "data_type": "instant",                              // å£°ç§°æ˜¯instantç±»å‹
  "source_task_id": "0b75c1a7-2fc0-58a8-8ee6-6dcebe4d85d3",
  "added_by": "current_user"
}
```

**å®é™…é”™è¯¯**:
```
Raw data '7c2a1e9e-e92e-4325-bd81-c8c3e29df0c5' not found in instant collection
```

**æ ¹æœ¬åŸå› **:
- **scheduledç±»å‹** (å®šæ—¶æœç´¢): ä½¿ç”¨ UUID æ ¼å¼ IDï¼Œå­˜å‚¨åœ¨ `search_results` é›†åˆ
- **instantç±»å‹** (å³æ—¶æœç´¢): ä½¿ç”¨é›ªèŠ±ç®—æ³• IDï¼ˆçº¯æ•°å­—å­—ç¬¦ä¸²ï¼‰ï¼Œå­˜å‚¨åœ¨ `instant_search_results` é›†åˆ
- å‰ç«¯é”™è¯¯åœ°å°† UUID æ ¼å¼çš„ ID å£°æ˜ä¸º `instant` ç±»å‹
- åç«¯æœªåšé˜²å¾¡æ€§æ ¡éªŒï¼Œç›´æ¥æŒ‰å‰ç«¯å£°æ˜çš„ç±»å‹æŸ¥è¯¢é”™è¯¯çš„é›†åˆ

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šæ·»åŠ è¯¦ç»†é”™è¯¯æ—¥å¿—

#### ä»£ç ä¿®æ”¹

**æ–‡ä»¶**: `src/api/v1/endpoints/data_source_management.py`

**ä¿®æ”¹ä½ç½®**: æ·»åŠ åŸå§‹æ•°æ®ç«¯ç‚¹ (ç¬¬237-238è¡Œ)

```python
# ä¿®å¤å‰
except ValueError as e:
    raise HTTPException(status_code=400, detail=str(e))

# ä¿®å¤å
except ValueError as e:
    logger.warning(
        f"æ·»åŠ åŸå§‹æ•°æ®ä¸šåŠ¡é€»è¾‘é”™è¯¯: {str(e)} "
        f"(data_source_id={data_source_id}, data_id={request.data_id}, data_type={request.data_type})"
    )
    raise HTTPException(status_code=400, detail=str(e))
```

**æ”¹è¿›æ•ˆæœ**:
- âœ… è®°å½•å®Œæ•´çš„é”™è¯¯ä¸Šä¸‹æ–‡ï¼ˆæ•°æ®æºIDã€æ•°æ®IDã€æ•°æ®ç±»å‹ï¼‰
- âœ… ä½¿ç”¨ WARNING çº§åˆ«ï¼ˆä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼Œéç³»ç»Ÿé”™è¯¯ï¼‰
- âœ… ä¾¿äºç”Ÿäº§ç¯å¢ƒé—®é¢˜è¿½è¸ªå’Œå®šä½

### ä¿®å¤2ï¼šæ™ºèƒ½IDæ ¼å¼æ£€æµ‹å’Œç±»å‹çº æ­£

#### æŠ€æœ¯æ–¹æ¡ˆ

å®ç°é˜²å¾¡æ€§ç¼–ç¨‹ç­–ç•¥ï¼Œåœ¨æœåŠ¡å±‚è‡ªåŠ¨æ£€æµ‹ ID æ ¼å¼å¹¶çº æ­£ `data_type`ã€‚

| ID æ ¼å¼ | æ£€æµ‹è§„åˆ™ | å®é™…ç±»å‹ | é›†åˆ | ç¤ºä¾‹ |
|---------|---------|---------|------|------|
| UUID | åŒ…å«æ¨ªæ  `-` | `scheduled` | `search_results` | `7c2a1e9e-e92e-4325-bd81-c8c3e29df0c5` |
| é›ªèŠ±ID | çº¯æ•°å­—å­—ç¬¦ä¸² | `instant` | `instant_search_results` | `242540877529686016` |

#### ä»£ç ä¿®æ”¹

**æ–‡ä»¶**: `src/services/data_curation_service.py`

**ä¿®æ”¹2.1**: æ·»åŠ æ™ºèƒ½æ£€æµ‹è¾…åŠ©æ–¹æ³• (ç¬¬956-978è¡Œ)

```python
def _detect_data_type_from_id(self, data_id: str) -> str:
    """æ™ºèƒ½æ£€æµ‹æ•°æ®IDç±»å‹

    è§„åˆ™ï¼š
    - UUIDæ ¼å¼ï¼ˆåŒ…å«æ¨ªæ ï¼Œå¦‚ 7c2a1e9e-e92e-4325-bd81-c8c3e29df0c5ï¼‰â†’ scheduled
    - çº¯æ•°å­—å­—ç¬¦ä¸²ï¼ˆé›ªèŠ±IDï¼Œå¦‚ 242540877529686016ï¼‰â†’ instant

    Args:
        data_id: æ•°æ®ID

    Returns:
        æ•°æ®ç±»å‹ï¼š'scheduled' æˆ– 'instant'
    """
    if '-' in data_id:
        # UUIDæ ¼å¼ï¼šåŒ…å«æ¨ªæ 
        return "scheduled"
    elif data_id.isdigit():
        # é›ªèŠ±IDæ ¼å¼ï¼šçº¯æ•°å­—å­—ç¬¦ä¸²
        return "instant"
    else:
        # æœªçŸ¥æ ¼å¼ï¼Œé»˜è®¤ä¸ºinstantï¼ˆæ–°ç³»ç»Ÿï¼‰
        logger.warning(f"âš ï¸  æœªçŸ¥IDæ ¼å¼ï¼Œé»˜è®¤ä¸ºinstant: {data_id}")
        return "instant"
```

**ä¿®æ”¹2.2**: `add_raw_data_to_source` æ–¹æ³•æ·»åŠ ç±»å‹çº æ­£ (ç¬¬306-315è¡Œ)

```python
# ğŸ›¡ï¸ æ™ºèƒ½IDæ ¼å¼æ£€æµ‹å’Œç±»å‹çº æ­£ï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰
# UUIDæ ¼å¼ï¼ˆå¸¦æ¨ªæ ï¼‰â†’ scheduled
# çº¯æ•°å­—å­—ç¬¦ä¸²ï¼ˆé›ªèŠ±IDï¼‰â†’ instant
actual_data_type = self._detect_data_type_from_id(data_id)
if actual_data_type != data_type:
    logger.warning(
        f"âš ï¸  æ•°æ®ç±»å‹è‡ªåŠ¨çº æ­£: data_id={data_id}, "
        f"å‰ç«¯å£°æ˜={data_type}, å®é™…æ£€æµ‹={actual_data_type}"
    )
    data_type = actual_data_type
```

**ä¿®æ”¹2.3**: `remove_raw_data_from_source` æ–¹æ³•åŒæ ·æ·»åŠ  (ç¬¬431-438è¡Œ)

ä¿æŒä¸€è‡´æ€§ï¼Œç§»é™¤æ“ä½œä¹Ÿåº”ç”¨ç›¸åŒçš„æ™ºèƒ½æ£€æµ‹é€»è¾‘ã€‚

---

## å½±å“èŒƒå›´åˆ†æ

### ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `src/api/v1/endpoints/data_source_management.py` - APIå±‚é”™è¯¯æ—¥å¿—
2. âœ… `src/services/data_curation_service.py` - æœåŠ¡å±‚æ™ºèƒ½æ£€æµ‹

### æœªä¿®æ”¹çš„æ–‡ä»¶

- âœ… `src/core/domain/entities/data_source.py` - Domainå±‚æ— éœ€ä¿®æ”¹
- âœ… `src/infrastructure/database/data_source_repositories.py` - ä»“å‚¨å±‚æ— éœ€ä¿®æ”¹

### å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å‘åå…¼å®¹**:
- æ™ºèƒ½æ£€æµ‹ä¸ç ´åæ­£ç¡®çš„è¯·æ±‚ï¼ˆç±»å‹åŒ¹é…æ—¶ç›´æ¥é€šè¿‡ï¼‰
- åªåœ¨ç±»å‹ä¸åŒ¹é…æ—¶è‡ªåŠ¨çº æ­£ï¼Œå¹¶è®°å½•è­¦å‘Šæ—¥å¿—
- å‰ç«¯æ­£ç¡®å®ç°åï¼Œè­¦å‘Šæ—¥å¿—è‡ªç„¶æ¶ˆå¤±

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1ï¼šUUIDæ ¼å¼IDè¢«é”™è¯¯æ ‡è®°ä¸ºinstant

**è¯·æ±‚**:
```json
{
  "data_id": "7c2a1e9e-e92e-4325-bd81-c8c3e29df0c5",
  "data_type": "instant",
  "added_by": "test_user"
}
```

**é¢„æœŸè¡Œä¸º**:
1. åç«¯æ£€æµ‹åˆ° UUID æ ¼å¼ï¼ˆåŒ…å«æ¨ªæ ï¼‰
2. è‡ªåŠ¨çº æ­£ `data_type` ä¸º `scheduled`
3. è®°å½•è­¦å‘Šæ—¥å¿—ï¼š
   ```
   WARNING - âš ï¸  æ•°æ®ç±»å‹è‡ªåŠ¨çº æ­£: data_id=7c2a1e9e-e92e-4325-bd81-c8c3e29df0c5, å‰ç«¯å£°æ˜=instant, å®é™…æ£€æµ‹=scheduled
   ```
4. åœ¨ `search_results` é›†åˆä¸­æŸ¥è¯¢æ•°æ®
5. å¦‚æœæ•°æ®å­˜åœ¨ä¸”çŠ¶æ€æ­£ç¡®ï¼Œæ·»åŠ æˆåŠŸ

### æµ‹è¯•åœºæ™¯2ï¼šé›ªèŠ±IDæ ¼å¼IDè¢«é”™è¯¯æ ‡è®°ä¸ºscheduled

**è¯·æ±‚**:
```json
{
  "data_id": "242540877529686016",
  "data_type": "scheduled",
  "added_by": "test_user"
}
```

**é¢„æœŸè¡Œä¸º**:
1. åç«¯æ£€æµ‹åˆ°é›ªèŠ±IDæ ¼å¼ï¼ˆçº¯æ•°å­—ï¼‰
2. è‡ªåŠ¨çº æ­£ `data_type` ä¸º `instant`
3. è®°å½•è­¦å‘Šæ—¥å¿—
4. åœ¨ `instant_search_results` é›†åˆä¸­æŸ¥è¯¢æ•°æ®

### æµ‹è¯•åœºæ™¯3ï¼šæ­£ç¡®çš„è¯·æ±‚ï¼ˆæ— çº æ­£ï¼‰

**è¯·æ±‚**:
```json
{
  "data_id": "242540877529686016",
  "data_type": "instant",
  "added_by": "test_user"
}
```

**é¢„æœŸè¡Œä¸º**:
1. æ£€æµ‹åˆ°ç±»å‹åŒ¹é…ï¼Œç›´æ¥é€šè¿‡
2. ä¸è®°å½•è­¦å‘Šæ—¥å¿—
3. æ­£å¸¸æŸ¥è¯¢å’Œå¤„ç†

### æµ‹è¯•åœºæ™¯4ï¼šæ•°æ®ä¸å­˜åœ¨é”™è¯¯æ—¥å¿—

**è¯·æ±‚**: å°è¯•æ·»åŠ ä¸å­˜åœ¨çš„æ•°æ®ID

**é¢„æœŸæ—¥å¿—**:
```
WARNING - æ·»åŠ åŸå§‹æ•°æ®ä¸šåŠ¡é€»è¾‘é”™è¯¯: Raw data 'xxx' not found in instant collection (data_source_id=242540877529686016, data_id=xxx, data_type=instant)
```

---

## éƒ¨ç½²è¯´æ˜

### éƒ¨ç½²æ­¥éª¤

1. **ä»£ç éƒ¨ç½²**: å°†ä¿®æ”¹åçš„æ–‡ä»¶éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
2. **æœåŠ¡é‡å¯**: uvicorn å·²å¯ç”¨ `--reload`ï¼Œä¿®æ”¹åè‡ªåŠ¨é‡å¯ï¼ˆè¿›ç¨‹ID: 40027ï¼‰
3. **éªŒè¯æµ‹è¯•**: ç›‘æ§æ—¥å¿—ï¼Œè§‚å¯Ÿç±»å‹çº æ­£è­¦å‘Š

### ç›‘æ§è¦ç‚¹

**å…³é”®æ—¥å¿—ç›‘æ§**:
```bash
# ç›‘æ§ç±»å‹çº æ­£æ—¥å¿—
grep "æ•°æ®ç±»å‹è‡ªåŠ¨çº æ­£" logs/fastapi.log

# ç›‘æ§ä¸šåŠ¡é€»è¾‘é”™è¯¯
grep "æ·»åŠ åŸå§‹æ•°æ®ä¸šåŠ¡é€»è¾‘é”™è¯¯" logs/fastapi.log
```

**é¢„æœŸç»“æœ**:
- çŸ­æœŸå†…å¯èƒ½å‡ºç°ç±»å‹çº æ­£è­¦å‘Šï¼ˆå‰ç«¯æœªä¿®å¤æ—¶ï¼‰
- æ•°æ®æ·»åŠ æ“ä½œæˆåŠŸç‡æå‡
- é”™è¯¯æ—¥å¿—åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡ä¿¡æ¯

### å›æ»šæ–¹æ¡ˆ

å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å›æ»šåˆ°ä¿®æ”¹å‰çš„ç‰ˆæœ¬ï¼š
- ç§»é™¤ `_detect_data_type_from_id` æ–¹æ³•
- ç§»é™¤æ™ºèƒ½æ£€æµ‹é€»è¾‘
- æ¢å¤åŸå§‹çš„å¼‚å¸¸å¤„ç†ï¼ˆæ— æ—¥å¿—ï¼‰

---

## é•¿æœŸæ”¹è¿›å»ºè®®

### å‰ç«¯ä¿®å¤ (æ¨è)

**æ ¹æœ¬è§£å†³æ–¹æ¡ˆ**: å‰ç«¯æ­£ç¡®è¯†åˆ«å’Œå‘é€æ•°æ®ç±»å‹

```typescript
// å‰ç«¯IDæ ¼å¼æ£€æµ‹å‡½æ•°
function detectDataType(dataId: string): 'scheduled' | 'instant' {
  if (dataId.includes('-')) {
    // UUIDæ ¼å¼ â†’ scheduled
    return 'scheduled';
  } else if (/^\d+$/.test(dataId)) {
    // çº¯æ•°å­— â†’ instant
    return 'instant';
  }
  // é»˜è®¤instantï¼ˆæ–°ç³»ç»Ÿï¼‰
  return 'instant';
}

// ä½¿ç”¨ç¤ºä¾‹
const dataType = detectDataType(selectedData.id);
const request = {
  data_id: selectedData.id,
  data_type: dataType,  // è‡ªåŠ¨æ£€æµ‹ï¼Œä¸ä¾èµ–å‰ç«¯æ‰‹åŠ¨é€‰æ‹©
  added_by: currentUser
};
```

### API æ–‡æ¡£æ›´æ–°

åœ¨ OpenAPI æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜ï¼š
```markdown
**data_id æ ¼å¼è§„èŒƒ**:
- scheduledç±»å‹: UUIDæ ¼å¼ (åŒ…å«æ¨ªæ ï¼Œå¦‚ `7c2a1e9e-e92e-4325-bd81-c8c3e29df0c5`)
- instantç±»å‹: é›ªèŠ±IDæ ¼å¼ (çº¯æ•°å­—å­—ç¬¦ä¸²ï¼Œå¦‚ `242540877529686016`)

**æ³¨æ„**: åç«¯ä¼šè‡ªåŠ¨æ£€æµ‹IDæ ¼å¼å¹¶çº æ­£data_typeï¼Œå»ºè®®å‰ç«¯ä¸»åŠ¨å®ç°æ£€æµ‹é€»è¾‘ã€‚
```

### ç»Ÿä¸€IDç³»ç»Ÿ (æœªæ¥æ¶æ„æ”¹è¿›)

**é•¿æœŸç›®æ ‡**: è¿ç§»æ‰€æœ‰ç³»ç»Ÿåˆ°é›ªèŠ±ç®—æ³• ID

- ä¼˜åŠ¿ï¼šå…¨å±€å”¯ä¸€ã€æ—¶é—´æœ‰åºã€åˆ†å¸ƒå¼å‹å¥½
- è¿ç§»ç­–ç•¥ï¼šä¿ç•™ UUID å…¼å®¹æ€§ï¼Œæ–°æ•°æ®ä½¿ç”¨é›ªèŠ±ID
- è¿‡æ¸¡æœŸï¼šç»§ç»­ä½¿ç”¨æ™ºèƒ½æ£€æµ‹é€»è¾‘

---

## ç›¸å…³æ–‡æ¡£

- [æ•°æ®æºç®¡ç†ç³»ç»Ÿæ¶æ„](SYSTEM_ARCHITECTURE.md)
- [æ•°æ®æºæ•´ç¼–åç«¯æ–‡æ¡£](DATA_SOURCE_CURATION_BACKEND.md)
- [ç©ºæ•°æ®æºç¡®è®¤ä¿®å¤](BUG_FIX_EMPTY_DATASOURCE_CONFIRM.md)

---

## å˜æ›´è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | ä¿®æ”¹å†…å®¹ | ä¿®æ”¹äºº |
|------|------|---------|--------|
| 2025-10-31 | v1.4.2 | æ·»åŠ é”™è¯¯æ—¥å¿—å’Œæ™ºèƒ½IDæ£€æµ‹ | Claude |
